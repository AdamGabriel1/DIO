# docs/file_integrity_monitor.py
import hashlib
import os
import json
import time
from datetime import datetime

DB_FILE = "file_hashes.json"

def calculate_hash(filepath):
    """Calcula SHA-256 do arquivo"""
    sha256 = hashlib.sha256()
    with open(filepath, "rb") as f:
        for chunk in iter(lambda: f.read(4096), b""):
            sha256.update(chunk)
    return sha256.hexdigest()

def scan_directory(directory):
    """Escaneia diretório e gera hashes"""
    hashes = {}
    for root, dirs, files in os.walk(directory):
        for file in files:
            filepath = os.path.join(root, file)
            try:
                hashes[filepath] = calculate_hash(filepath)
            except Exception as e:
                print(f"[!] Erro em {filepath}: {e}")
    return hashes

def save_baseline(hashes):
    """Salva baseline de hashes"""
    with open(DB_FILE, "w") as f:
        json.dump(hashes, f, indent=2)
    print(f"[+] Baseline salva: {len(hashes)} arquivos")

def check_integrity():
    """Verifica integridade atual contra baseline"""
    if not os.path.exists(DB_FILE):
        print("[-] Baseline não encontrada. Execute scan primeiro.")
        return
    
    with open(DB_FILE, "r") as f:
        baseline = json.load(f)
    
    current = scan_directory(".")
    alerts = []
    
    for filepath, old_hash in baseline.items():
        if filepath not in current:
            alerts.append(f"[!] ARQUIVO REMOVIDO: {filepath}")
        elif current[filepath] != old_hash:
            alerts.append(f"[!] ARQUIVO MODIFICADO: {filepath}")
    
    for filepath in current:
        if filepath not in baseline:
            alerts.append(f"[!] NOVO ARQUIVO: {filepath}")
    
    if alerts:
        print(f"\n[!] ALERTAS DE INTEGRIDADE ({datetime.now()})")
        for alert in alerts:
            print(alert)
    else:
        print(f"[+] Integridade verificada: sem alterações ({datetime.now()})")

if __name__ == "__main__":
    import sys
    if len(sys.argv) < 2:
        print("Uso: python file_integrity_monitor.py [scan|check]")
        sys.exit(1)
    
    if sys.argv[1] == "scan":
        hashes = scan_directory(".")
        save_baseline(hashes)
    elif sys.argv[1] == "check":
        check_integrity()
